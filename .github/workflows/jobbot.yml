import json
import os
import hashlib
import requests
from bs4 import BeautifulSoup

URL = "https://sainsburys.jobs/jobs?full_time=&part_time=on&fixed_term=&filter_by=&location=eh14+4as&keywords="
STATE_FILE = "seen_jobs.json"

TG_BOT_TOKEN = os.environ.get("TG_BOT_TOKEN", "").strip()
TG_CHAT_ID = os.environ.get("TG_CHAT_ID", "").strip()

# اگر این = 1 باشد، هر بار یک پیام تست می‌فرستد
ALWAYS_SEND_TEST = os.environ.get("ALWAYS_SEND_TEST", "0").strip() == "1"


def send_telegram(text: str):
    if not TG_BOT_TOKEN or not TG_CHAT_ID:
        raise RuntimeError("Missing TG_BOT_TOKEN or TG_CHAT_ID. Check GitHub Secrets.")

    api = f"https://api.telegram.org/bot{TG_BOT_TOKEN}/sendMessage"
    r = requests.post(api, data={"chat_id": TG_CHAT_ID, "text": text}, timeout=25)

    if r.status_code != 200:
        # متن دقیق خطای تلگرام را نشان می‌دهد
        raise RuntimeError(f"Telegram error {r.status_code}: {r.text}")


def load_seen():
    try:
        with open(STATE_FILE, "r", encoding="utf-8") as f:
            return set(json.load(f))
    except FileNotFoundError:
        return set()
    except Exception as e:
        raise RuntimeError(f"Failed to read {STATE_FILE}: {e}")


def save_seen(seen):
    try:
        with open(STATE_FILE, "w", encoding="utf-8") as f:
            json.dump(sorted(list(seen)), f, ensure_ascii=False, in_
